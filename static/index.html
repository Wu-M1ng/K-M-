<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiro Account Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { color: #333; margin-bottom: 10px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; }
        .stat-card h3 { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
        .stat-card .value { font-size: 24px; font-weight: bold; }
        .controls { background: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .batch-controls { background: #fff3cd; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; display: none; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .batch-controls.show { display: flex; }
        .batch-controls .selected-count { font-weight: bold; color: #856404; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #667eea; }
        .account-checkbox { position: absolute; top: 15px; left: 15px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; }
        .btn-info { background: #4299e1; color: white; }
        .btn-info:hover { background: #3182ce; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-warning:hover { background: #dd6b20; }
        .accounts-grid { display: grid; gap: 15px; }
        .account-card { background: white; padding: 20px; padding-left: 45px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .account-card.current { border: 2px solid #48bb78; }
        .current-badge { position: absolute; top: 10px; right: 10px; background: #48bb78; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .account-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .account-email { font-weight: bold; color: #333; font-size: 16px; }
        .account-status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-active { background: #c6f6d5; color: #22543d; }
        .account-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .detail-item { font-size: 13px; color: #666; }
        .detail-label { font-weight: 500; color: #333; }
        .progress-bar { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; transition: width 0.3s; }
        .progress-fill.low { background: linear-gradient(90deg, #48bb78, #38a169); }
        .progress-fill.medium { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .progress-fill.high { background: linear-gradient(90deg, #f56565, #e53e3e); }
        .account-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .machine-id { font-family: monospace; background: #f7fafc; padding: 8px; border-radius: 4px; font-size: 11px; margin-top: 10px; }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Kiro Account Manager</h1>
            <div class="stats" id="stats"></div>
        </div>
        <div class="controls">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label for="selectAll" style="font-size: 13px; cursor: pointer;">å…¨é€‰</label>
            </div>
            <button class="btn btn-primary" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥</button>
            <button class="btn btn-success" onclick="triggerRefresh()">ğŸ”„ åˆ·æ–°æ‰€æœ‰</button>
            <button class="btn btn-primary" onclick="exportAccounts()">ğŸ“¤ å¯¼å‡º</button>
            <button class="btn btn-warning" onclick="showSettingsModal()">âš™ï¸ è®¾ç½®</button>
            <button class="btn btn-danger" onclick="logout()" style="margin-left: auto;">ğŸšª é€€å‡º</button>
        </div>
        <div class="batch-controls" id="batchControls">
            <span class="selected-count">å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªè´¦å·</span>
            <button class="btn btn-success" onclick="batchRefresh()">ğŸ”„ æ‰¹é‡åˆ·æ–°</button>
            <button class="btn btn-primary" onclick="batchExport()">ğŸ“¤ æ‰¹é‡å¯¼å‡º</button>
            <button class="btn btn-danger" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
            <button class="btn" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
        </div>
        <div class="accounts-grid" id="accounts"></div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">ğŸ“¥ å¯¼å…¥è´¦å·</h2>
            <textarea id="importJson" placeholder="ç²˜è´´ JSON æ•°æ®..."></textarea>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="importAccounts()">å¯¼å…¥</button>
                <button class="btn" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal" id="detailsModal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 15px;">ğŸ“‹ è´¦å·è¯¦æƒ…</h2>
            <div id="accountDetails"></div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="copyAccountDetails()">ğŸ“‹ å¤åˆ¶JSON</button>
                <button class="btn" onclick="closeModal('detailsModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 style="margin-bottom: 20px;">âš™ï¸ å®šæ—¶ä»»åŠ¡è®¾ç½®</h2>
            <div id="settingsContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                <button class="btn" onclick="closeModal('settingsModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; max-width: 600px; margin: 50px auto; padding: 30px; border-radius: 8px; }
        .modal-content textarea { width: 100%; height: 250px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .detail-section { background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .detail-section h3 { font-size: 14px; color: #667eea; margin-bottom: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .detail-row { display: flex; margin-bottom: 8px; font-size: 13px; align-items: flex-start; }
        .detail-row .label { font-weight: 600; color: #333; min-width: 130px; flex-shrink: 0; }
        .detail-row .value { color: #666; word-break: break-all; flex: 1; }
        .token-value { font-family: monospace; font-size: 10px; background: #edf2f7; padding: 8px; border-radius: 4px; max-height: 60px; overflow-y: auto; word-break: break-all; margin-top: 5px; }
        .copy-btn { font-size: 11px; padding: 2px 8px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 4px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .setting-group { margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; }
        .setting-group h3 { font-size: 14px; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .setting-row { display: flex; align-items: center; margin-bottom: 10px; }
        .setting-row label { flex: 1; font-size: 13px; color: #555; }
        .setting-row input[type="number"] { width: 100px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; }
        .setting-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .setting-row select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; }
        .setting-hint { font-size: 11px; color: #888; margin-top: 4px; }
        .scheduler-status { font-size: 12px; color: #48bb78; margin-top: 10px; }
    </style>

    <script>
        let accounts = [];
        let currentAccountDetails = null;
        let currentSettings = null;
        let selectedAccounts = new Set();

        // Initialize
        (async () => {
            if (await checkAuth()) {
                loadAccounts();
                loadSettings();
                setInterval(loadAccounts, 60000); // Refresh every minute
            }
        })();

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', { credentials: 'same-origin' });
                const data = await response.json();
                if (data.authRequired && !data.authenticated) {
                    window.location.replace('/login');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                return false;
            }
        }

        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
            window.location.replace('/login');
        }

        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts', { credentials: 'same-origin' });
                const data = await response.json();
                accounts = data.accounts || [];
                renderAccounts();
                loadStats();
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats', { credentials: 'same-origin' });
                const stats = await response.json();
                const refreshStatus = stats.autoRefreshEnabled ? 
                    `<span style="color:#48bb78">âœ“ è‡ªåŠ¨åˆ·æ–° (${formatInterval(stats.autoRefreshInterval)})</span>` : 
                    `<span style="color:#f56565">âœ— è‡ªåŠ¨åˆ·æ–°å…³é—­</span>`;
                const switchStatus = stats.autoSwitchEnabled ? 
                    `<span style="color:#48bb78">âœ“ è‡ªåŠ¨æ¢å·</span>` : '';
                
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card"><h3>æ€»è´¦å·</h3><div class="value">${stats.total}</div></div>
                    <div class="stat-card"><h3>æ´»è·ƒ</h3><div class="value">${stats.active}</div></div>
                    <div class="stat-card"><h3>æ€»é¢åº¦</h3><div class="value">${stats.totalCredits.toFixed(0)}</div></div>
                    <div class="stat-card"><h3>å·²ä½¿ç”¨</h3><div class="value">${stats.usedCredits.toFixed(0)}</div></div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                        <h3>å®šæ—¶ä»»åŠ¡</h3><div style="font-size:12px;">${refreshStatus}<br>${switchStatus}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function formatInterval(seconds) {
            if (seconds < 60) return `${seconds}ç§’`;
            if (seconds < 3600) return `${Math.floor(seconds/60)}åˆ†é’Ÿ`;
            return `${Math.floor(seconds/3600)}å°æ—¶`;
        }

        function renderAccounts() {
            const container = document.getElementById('accounts');
            if (accounts.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— è´¦å·ï¼Œè¯·å¯¼å…¥è´¦å·æ•°æ®</div>';
                return;
            }
            container.innerHTML = accounts.map(account => {
                const usage = account.usage || {};
                // è®¡ç®—æ€»é¢åº¦ = æ™®é€šé¢åº¦ + è¯•ç”¨é¢åº¦
                const totalLimit = (usage.limit || 0) + (usage.freeTrialLimit || 0);
                const totalCurrent = (usage.current || 0) + (usage.freeTrialCurrent || 0);
                const percentUsed = totalLimit ? ((totalCurrent / totalLimit) * 100) : 0;
                const progressClass = percentUsed > 90 ? 'high' : percentUsed > 70 ? 'medium' : 'low';
                const currentClass = account.isCurrent ? 'current' : '';
                const currentBadge = account.isCurrent ? '<span class="current-badge">å½“å‰ä½¿ç”¨</span>' : '';
                const isChecked = selectedAccounts.has(account.id) ? 'checked' : '';
                
                // è®¡ç®—è¯•ç”¨é¢åº¦å‰©ä½™å¤©æ•°
                let daysRemaining = 'N/A';
                if (usage.freeTrialExpiry) {
                    const expiry = new Date(usage.freeTrialExpiry);
                    const now = new Date();
                    const days = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                    daysRemaining = days > 0 ? days + ' å¤©' : 'å·²è¿‡æœŸ';
                } else if (account.subscription?.daysRemaining !== undefined) {
                    daysRemaining = account.subscription.daysRemaining + ' å¤©';
                }
                
                return `
                    <div class="account-card ${currentClass}">
                        <input type="checkbox" class="account-checkbox" data-id="${account.id}" ${isChecked} onchange="toggleAccountSelection('${account.id}')">
                        ${currentBadge}
                        <div class="account-header">
                            <div class="account-email">${account.email}</div>
                            <span class="account-status status-${account.status}">${account.status}</span>
                        </div>
                        <div class="account-details">
                            <div class="detail-item"><span class="detail-label">Provider:</span> ${account.idp}</div>
                            <div class="detail-item"><span class="detail-label">Nickname:</span> ${account.nickname}</div>
                            <div class="detail-item"><span class="detail-label">è®¢é˜…:</span> ${account.subscription?.type || 'N/A'}</div>
                            <div class="detail-item"><span class="detail-label">å‰©ä½™å¤©æ•°:</span> ${daysRemaining}</div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px;">
                                <span>é¢åº¦ä½¿ç”¨</span>
                                <span>${totalCurrent.toFixed(2)} / ${totalLimit.toFixed(0)} (${percentUsed.toFixed(1)}%)</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width: ${Math.min(percentUsed, 100)}%"></div></div>
                        </div>
                        <div class="machine-id"><strong>Machine ID:</strong> ${account.machineId || 'æœªç»‘å®š'}</div>
                        <div class="account-actions">
                            <button class="btn btn-info" onclick="showAccountDetails('${account.id}')">ğŸ“‹ è¯¦æƒ…</button>
                            <button class="btn btn-success" onclick="refreshToken('${account.id}')">ğŸ”„ åˆ·æ–°</button>
                            ${!account.isCurrent ? `<button class="btn btn-warning" onclick="setCurrentAccount('${account.id}')">â­ è®¾ä¸ºå½“å‰</button>` : ''}
                            <button class="btn btn-primary" onclick="regenerateMachineId('${account.id}')">ğŸ”‘ æœºå™¨ç </button>
                            <button class="btn btn-danger" onclick="deleteAccount('${account.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
            updateBatchControls();
        }

        // Selection functions
        function toggleAccountSelection(accountId) {
            if (selectedAccounts.has(accountId)) {
                selectedAccounts.delete(accountId);
            } else {
                selectedAccounts.add(accountId);
            }
            updateBatchControls();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox.checked) {
                accounts.forEach(a => selectedAccounts.add(a.id));
            } else {
                selectedAccounts.clear();
            }
            renderAccounts();
        }

        function clearSelection() {
            selectedAccounts.clear();
            document.getElementById('selectAll').checked = false;
            renderAccounts();
        }

        function updateBatchControls() {
            const count = selectedAccounts.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('batchControls').classList.toggle('show', count > 0);
            document.getElementById('selectAll').checked = count > 0 && count === accounts.length;
        }

        async function batchRefresh() {
            if (selectedAccounts.size === 0) return;
            if (!confirm(`ç¡®å®šè¦åˆ·æ–°é€‰ä¸­çš„ ${selectedAccounts.size} ä¸ªè´¦å·çš„ Token å—ï¼Ÿ`)) return;
            
            let success = 0, failed = 0;
            for (const accountId of selectedAccounts) {
                try {
                    const response = await fetch(`/api/accounts/${accountId}/refresh`, {
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    const result = await response.json();
                    if (result.success) success++;
                    else failed++;
                } catch (error) {
                    failed++;
                }
            }
            alert(`æ‰¹é‡åˆ·æ–°å®Œæˆï¼šæˆåŠŸ ${success} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`);
            loadAccounts();
        }

        async function batchDelete() {
            if (selectedAccounts.size === 0) return;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedAccounts.size} ä¸ªè´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            let success = 0, failed = 0;
            for (const accountId of selectedAccounts) {
                try {
                    const response = await fetch(`/api/accounts/${accountId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    const result = await response.json();
                    if (result.success) success++;
                    else failed++;
                } catch (error) {
                    failed++;
                }
            }
            selectedAccounts.clear();
            alert(`æ‰¹é‡åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${success} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`);
            loadAccounts();
        }

        async function batchExport() {
            if (selectedAccounts.size === 0) return;
            
            const selectedData = {
                version: "1.3.1",
                exportedAt: Date.now(),
                accounts: accounts.filter(a => selectedAccounts.has(a.id)),
                groups: [],
                tags: []
            };
            
            const blob = new Blob([JSON.stringify(selectedData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kiro-accounts-selected-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Settings functions
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings', { credentials: 'same-origin' });
                const data = await response.json();
                if (data.success) {
                    currentSettings = data.settings;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function showSettingsModal() {
            if (!currentSettings) {
                alert('è®¾ç½®åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•');
                loadSettings();
                return;
            }
            
            const ar = currentSettings.autoRefresh;
            const as = currentSettings.autoSwitch;
            const scheduler = currentSettings.scheduler || {};
            
            let nextRunInfo = '';
            if (scheduler.jobs && scheduler.jobs.length > 0) {
                const refreshJob = scheduler.jobs.find(j => j.id === 'auto_refresh');
                if (refreshJob && refreshJob.nextRun) {
                    nextRunInfo = `<div class="scheduler-status">ä¸‹æ¬¡åˆ·æ–°: ${new Date(refreshJob.nextRun).toLocaleString('zh-CN')}</div>`;
                }
            }
            
            document.getElementById('settingsContent').innerHTML = `
                <div class="setting-group">
                    <h3>ğŸ”„ è‡ªåŠ¨åˆ·æ–° Token</h3>
                    <div class="setting-row">
                        <label>å¯ç”¨è‡ªåŠ¨åˆ·æ–°</label>
                        <input type="checkbox" id="autoRefreshEnabled" ${ar.enabled ? 'checked' : ''}>
                    </div>
                    <div class="setting-row">
                        <label>åˆ·æ–°é—´éš”</label>
                        <select id="refreshInterval">
                            <option value="900" ${ar.interval == 900 ? 'selected' : ''}>15 åˆ†é’Ÿ</option>
                            <option value="1800" ${ar.interval == 1800 ? 'selected' : ''}>30 åˆ†é’Ÿ</option>
                            <option value="3600" ${ar.interval == 3600 ? 'selected' : ''}>1 å°æ—¶</option>
                            <option value="7200" ${ar.interval == 7200 ? 'selected' : ''}>2 å°æ—¶</option>
                            <option value="14400" ${ar.interval == 14400 ? 'selected' : ''}>4 å°æ—¶</option>
                            <option value="21600" ${ar.interval == 21600 ? 'selected' : ''}>6 å°æ—¶</option>
                            <option value="43200" ${ar.interval == 43200 ? 'selected' : ''}>12 å°æ—¶</option>
                            <option value="86400" ${ar.interval == 86400 ? 'selected' : ''}>24 å°æ—¶</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>æå‰åˆ·æ–°æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="refreshBeforeExpiry" value="${ar.refreshBeforeExpiry || 300}" min="60" max="3600">
                    </div>
                    <div class="setting-hint">Token è¿‡æœŸå‰å¤šå°‘ç§’å¼€å§‹åˆ·æ–°</div>
                    ${nextRunInfo}
                </div>
                
                <div class="setting-group">
                    <h3>ğŸ”€ è‡ªåŠ¨æ¢å·</h3>
                    <div class="setting-row">
                        <label>å¯ç”¨è‡ªåŠ¨æ¢å·</label>
                        <input type="checkbox" id="autoSwitchEnabled" ${as.enabled ? 'checked' : ''}>
                    </div>
                    <div class="setting-row">
                        <label>æ£€æŸ¥é—´éš”</label>
                        <select id="switchCheckInterval">
                            <option value="900" ${as.checkInterval == 900 ? 'selected' : ''}>15 åˆ†é’Ÿ</option>
                            <option value="1800" ${as.checkInterval == 1800 ? 'selected' : ''}>30 åˆ†é’Ÿ</option>
                            <option value="3600" ${as.checkInterval == 3600 ? 'selected' : ''}>1 å°æ—¶</option>
                            <option value="7200" ${as.checkInterval == 7200 ? 'selected' : ''}>2 å°æ—¶</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>åˆ‡æ¢é˜ˆå€¼ (%)</label>
                        <input type="number" id="switchThreshold" value="${as.switchThreshold || 90}" min="50" max="100">
                    </div>
                    <div class="setting-hint">å½“å‰è´¦å·ä½¿ç”¨ç‡è¶…è¿‡æ­¤å€¼æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä½¿ç”¨ç‡æœ€ä½çš„è´¦å·</div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-info" onclick="triggerRefresh()" style="margin-right: 10px;">ç«‹å³åˆ·æ–°æ‰€æœ‰ Token</button>
                    <button class="btn btn-warning" onclick="triggerSwitch()">ç«‹å³æ£€æŸ¥æ¢å·</button>
                </div>
            `;
            
            document.getElementById('settingsModal').style.display = 'block';
        }

        async function saveSettings() {
            try {
                const settings = {
                    autoRefresh: {
                        enabled: document.getElementById('autoRefreshEnabled').checked,
                        interval: parseInt(document.getElementById('refreshInterval').value),
                        refreshBeforeExpiry: parseInt(document.getElementById('refreshBeforeExpiry').value)
                    },
                    autoSwitch: {
                        enabled: document.getElementById('autoSwitchEnabled').checked,
                        checkInterval: parseInt(document.getElementById('switchCheckInterval').value),
                        switchThreshold: parseInt(document.getElementById('switchThreshold').value)
                    }
                };
                
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentSettings = result.settings;
                    alert('è®¾ç½®å·²ä¿å­˜');
                    closeModal('settingsModal');
                    loadStats();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function triggerRefresh() {
            if (!confirm('ç¡®å®šè¦ç«‹å³åˆ·æ–°æ‰€æœ‰è´¦å·çš„ Token å—ï¼Ÿ')) return;
            try {
                const response = await fetch('/api/scheduler/trigger/auto_refresh', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                alert(result.message || 'åˆ·æ–°ä»»åŠ¡å·²è§¦å‘');
                loadAccounts();
            } catch (error) {
                alert('è§¦å‘å¤±è´¥: ' + error.message);
            }
        }

        async function triggerSwitch() {
            try {
                const response = await fetch('/api/scheduler/trigger/auto_switch', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                alert(result.message || 'æ¢å·æ£€æŸ¥å·²è§¦å‘');
                loadAccounts();
            } catch (error) {
                alert('è§¦å‘å¤±è´¥: ' + error.message);
            }
        }

        async function setCurrentAccount(accountId) {
            try {
                const response = await fetch(`/api/accounts/${accountId}/set-current`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    loadAccounts();
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        // Modal functions
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'importModal') document.getElementById('importJson').value = '';
        }

        // Account operations
        async function importAccounts() {
            try {
                const json = document.getElementById('importJson').value;
                if (!json.trim()) { alert('è¯·ç²˜è´´ JSON æ•°æ®'); return; }
                const data = JSON.parse(json);
                const response = await fetch('/api/accounts/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    closeModal('importModal');
                    loadAccounts();
                } else {
                    alert('å¯¼å…¥å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        }

        async function refreshToken(accountId) {
            try {
                const response = await fetch(`/api/accounts/${accountId}/refresh`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                alert(result.success ? 'Token åˆ·æ–°æˆåŠŸ' : 'åˆ·æ–°å¤±è´¥: ' + (result.message || result.error));
                loadAccounts();
            } catch (error) {
                alert('åˆ·æ–°å¤±è´¥: ' + error.message);
            }
        }

        async function regenerateMachineId(accountId) {
            try {
                const response = await fetch(`/api/accounts/${accountId}/machine-id`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                if (result.success) {
                    alert('æœºå™¨ç å·²é‡æ–°ç”Ÿæˆ');
                    loadAccounts();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        async function deleteAccount(accountId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                const result = await response.json();
                if (result.success) {
                    alert('è´¦å·å·²åˆ é™¤');
                    loadAccounts();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function exportAccounts() {
            try {
                const response = await fetch('/api/export', { credentials: 'same-origin' });
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kiro-accounts-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        async function showAccountDetails(accountId) {
            try {
                const response = await fetch(`/api/accounts/${accountId}/details`, { credentials: 'same-origin' });
                const result = await response.json();
                if (!result.success) { alert('è·å–è¯¦æƒ…å¤±è´¥: ' + result.error); return; }
                
                currentAccountDetails = result.account;
                const account = result.account;
                const credentials = account.credentials || {};
                const usage = account.usage || {};
                const subscription = account.subscription || {};
                const formatDate = (ts) => ts ? new Date(ts).toLocaleString('zh-CN') : 'N/A';
                
                // è®¡ç®—æ€»é¢åº¦
                const totalLimit = (usage.limit || 0) + (usage.freeTrialLimit || 0);
                const totalCurrent = (usage.current || 0) + (usage.freeTrialCurrent || 0);
                
                // è®¡ç®—è¯•ç”¨å‰©ä½™å¤©æ•°
                let trialDaysRemaining = 'N/A';
                if (usage.freeTrialExpiry) {
                    const expiry = new Date(usage.freeTrialExpiry);
                    const now = new Date();
                    const days = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                    trialDaysRemaining = days > 0 ? days + ' å¤©' : 'å·²è¿‡æœŸ';
                }

                document.getElementById('accountDetails').innerHTML = `
                    <div class="detail-section">
                        <h3>ğŸ“§ åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="detail-row"><span class="label">ID:</span><span class="value">${account.id || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Email:</span><span class="value">${account.email}</span></div>
                        <div class="detail-row"><span class="label">Nickname:</span><span class="value">${account.nickname}</span></div>
                        <div class="detail-row"><span class="label">User ID:</span><span class="value">${account.userId || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Provider:</span><span class="value">${account.idp}</span></div>
                        <div class="detail-row"><span class="label">Machine ID:</span><span class="value">${account.machineId || 'æœªç»‘å®š'}</span></div>
                    </div>
                    <div class="detail-section">
                        <h3>ğŸ’³ è®¢é˜… & ä½¿ç”¨</h3>
                        <div class="detail-row"><span class="label">è®¢é˜…ç±»å‹:</span><span class="value">${subscription.type || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">æ€»é¢åº¦:</span><span class="value">${totalCurrent.toFixed(2)} / ${totalLimit.toFixed(0)}</span></div>
                        <div class="detail-row"><span class="label">æ™®é€šé¢åº¦:</span><span class="value">${(usage.current || 0).toFixed(2)} / ${usage.limit || 0}</span></div>
                        <div class="detail-row"><span class="label">è¯•ç”¨é¢åº¦:</span><span class="value">${(usage.freeTrialCurrent || 0).toFixed(2)} / ${usage.freeTrialLimit || 0}</span></div>
                        <div class="detail-row"><span class="label">è¯•ç”¨å‰©ä½™:</span><span class="value">${trialDaysRemaining}</span></div>
                        <div class="detail-row"><span class="label">è¯•ç”¨åˆ°æœŸ:</span><span class="value">${usage.freeTrialExpiry ? formatDate(usage.freeTrialExpiry) : 'N/A'}</span></div>
                    </div>
                    <div class="detail-section">
                        <h3>ğŸ”‘ å‡­è¯</h3>
                        <div class="detail-row"><span class="label">Auth Method:</span><span class="value">${credentials.authMethod || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Region:</span><span class="value">${credentials.region || 'N/A'}</span></div>
                        <div class="detail-row"><span class="label">Token è¿‡æœŸ:</span><span class="value">${formatDate(credentials.expiresAt)}</span></div>
                        <div style="margin-top: 10px;">
                            <div class="detail-row"><span class="label">Access Token:</span><button class="copy-btn" onclick="copyText('accessToken')">å¤åˆ¶</button></div>
                            <div class="token-value" id="accessToken">${credentials.accessToken || 'N/A'}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <div class="detail-row"><span class="label">Refresh Token:</span><button class="copy-btn" onclick="copyText('refreshToken')">å¤åˆ¶</button></div>
                            <div class="token-value" id="refreshToken">${credentials.refreshToken || 'N/A'}</div>
                        </div>
                    </div>
                `;
                document.getElementById('detailsModal').style.display = 'block';
            } catch (error) {
                alert('è·å–è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        function copyText(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶')).catch(() => alert('å¤åˆ¶å¤±è´¥'));
        }

        function copyAccountDetails() {
            if (currentAccountDetails) {
                navigator.clipboard.writeText(JSON.stringify(currentAccountDetails, null, 2))
                    .then(() => alert('å·²å¤åˆ¶')).catch(() => alert('å¤åˆ¶å¤±è´¥'));
            }
        }
    </script>
</body>
</html>
